\documentclass[%
bachelor,    % тип документа
natbib,      % использовать пакет natbib для "сжатия" цитирований
subf,        % использовать пакет subcaption для вложенной нумерации рисунков
href,        % использовать пакет hyperref для создания гиперссылок
colorlinks,  % цветные гиперссылки
%fixint,     % включить прямые знаки интегралов
]{disser}

\usepackage[
  a4paper, mag=1000,
  left=2.5cm, right=1cm, top=2cm, bottom=2cm, headsep=0.7cm, footskip=1cm
]{geometry}

\usepackage{cmap} \usepackage[T2A]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage{mathtext}
\usepackage[english,russian]{babel}
\usepackage{commath}
\usepackage{gensymb}
\usepackage{amsmath, amssymb,amsfonts}
\usepackage{bm}
\usepackage{mathtools}
\usepackage{indentfirst}

\usepackage{fancyhdr} 

\usepackage{floatrow}
\floatsetup[table]{capposition=top}

\usepackage{tikz}
\usepackage{tikz-3dplot}
\usetikzlibrary{shapes, arrows}

\setcounter{tocdepth}{2}

\renewcommand\maketitle{
   \input{title}
   \normalfont\clearpage
}

%numbers at the bottom
\fancyhf{} 
\cfoot{\thepage}
\pagestyle{plain}  

\begin{document}

\maketitle

\tableofcontents
%numbersat the bottom for table of contents too
\addtocontents{toc}{\protect\thispagestyle{plain}}

\newpage


\clearpage\section{Введение}

Задача определения собственного местоположения является одной из важнейших задач робототехники.
Компьютерное зрение может предоставить альтернативу существующим методам, таким как GPS, которая является более точной и повсеместно доступной, а использование обычных камер позволяет создавать дешёвые решения, в отличие от использования более продвинутых оптических систем, например, лидаров.
Полученные алгоритмы также могут быть использованы и в других областях, таких как 3D-реконструкция и дополненная реальность.

В данной работе будет рассматриваться задача локализации относительно облака 3D точек, в которой используются проекции этих точек на фотографии.
Ради возможности использования данных алгоритмов в неспециализированных многопользовательских приложениях, не будет предполагаться, что внутренние параметры камеры известны. То есть в данной работе будет рассматриваться более общая задача, предполагающая некалиброванную камеру.
Данная задача не является новой, и цель данной работы -- найти наиболее быстрый алгоритм, который можно было бы применять в реальном времени.

\subsection{Формальная постановка задачи}
В данной работе рассматривается классическая pinhole модель камеры \cite{mvg}, в которой камера задаётся с помощью точки и плоскости. 
Изображение получается с помощью центральной проекции через точку на плоскость. 
В упрощённой модели камеры, которая использована в данной работе, единственным внутренним параметром является расстояние $f$ от данной точки до плоскости  -- фокусное расстояние.

Название задачи, которой посвящена эта работа -- Perspective-n-Point (PnP).
В этой задаче даны $n$ пар соответствий между точками в пространстве и точками на изображении. 
Точка $X_i$ из пространства соответствует точке $x_i$ на изображении, если последняя является проекцией первой ($i\in\{1,\ldots ,n\}$).
С~помощью данных соответствий требуется оценить неизвестные параметры камеры.
В рассматриваемой задаче, это внешние параметры: координаты центра камеры $C$, её вращение $R$, а также внутренний параметр -- фокусное расстояние $f$.
Так как фокусное расстояние является одной из неизвестных, то такой вариант задачи называется PnPf.
В терминах такой параметризации задача сводится к решению системы уравнений $P\widetilde{X}_i = \widetilde{x}_i, i\in\{1,\ldots ,n\}$, где 
\begin{equation*}
    P = \begin{bmatrix}
    f & & \\
    & f & \\
    & & 1
  \end{bmatrix}\cdot R\cdot[I_3|-C]
\end{equation*}
 -- матрица проекции (ссылка на супер книгу) ($I_3$ -- единичная матрица 3х3), $\widetilde{X}_i = [X_i, 1]$ и $\widetilde{x}_i = [x_i, 1]$ -- координаты в соответствующих проективных пространствах (ещё раз ссылку).

Ввиду того, что в наборах соответствий часто присутствуют неверно найденные пары, выбор оценки параметров производится с помощью RANSAC (RANdom SAmple Consensus) метода. 
Данный метод является итеративным, на каждой итерации метода выбираются случайные $n$ пар из набора соответствий, для которых, с помощью рассматриваемых в данной работе алгоритмов, вычисляются оценки параметров. 
Найденные параметры проверяются для остальных пар точек, и подсчитывается количество пар соответствий, удовлетворяющих гипотезе о том, что текущая оценка является верной, в нашем случае проверяется удовлетворение уравнению $P\widetilde X = \widetilde x$ (с некоторым порогом). В конце выбираются параметры, удовлетворяющие наибольшему количеству соответствий. Количество итераций в методе зависит от желаемой вероятности ошибки: чем больше итераций, тем, соответственно, меньше вероятность нахождения неудовлетворительной оценки.

\subsection{Цель и задачи работы}
Цель данной работы является выбрать алгоритм, наиболее подходящий для решения задачи PnPf в реальном времени.
В силу ограничений реального времени особенно важно, чтобы алгоритм хорошо работал с числами в одинарной точности, это позволит существенно убыстрить выполнение программы.

Для более удобного тестирования одной из задач данной работы будет встраивание выбранных алгоритма в библиотеку colmap.
Сейчас в colmap для решения данной задачи используется следующий подход: перебираются значения фокусного расстояния, а затем решается задача Р3Р и с помощью RANSAC выбирается наилучшее множество параметров: угаданное фокусное расстояние и оценённые центр и вращение.
При существовании алгоритмов, способных находить фокусное расстояние, а не угадывать его, данный подход вызывает сомнения в плане оптимальности.

Таким образом, задачами данной работы являются:
\begin{enumerate}
    \item Выбор алгоритмов подходящих для решения задачи PnPf и их реализация;
    \item Интеграция алгоритмов в библиотеку colmap;
    \item Сравнение производительности и точности выбранных алгоритмов;
    \item Перенос алгоритма, выбранного наилучшим, на gpgpu.
\end{enumerate}

\clearpage\section{Обзор алгоритмов}

В данной работе были рассмотрен два алгоритма \cite{p35p} и \cite{p4p}, невырожденные случаи которых были реализованы в MATLAB, а затем трансформированы в код на C++ с помощью Matlab Coder. Данный подход даёт возможность быстро получить работающий алгоритм, используя удобный набора инструментов для решения математических задач в MATLAB, а преобразование в С++ позволяет воспользоваться скоростными преимуществами.
Полученные алгоритмы были упакованы в шаблонный класс-обёртку Solver с использованием библиотеки Eigen.
%р3.5р 
\subsection{P3.5Pf}
    Так как задача оценки позы камеры имеет 7 степеней свободы (3 параметра для вращения, 3 для центра и 1 для фокусного расстояния), а каждое из соответствий даёт два ограничения (по каждой из координат), то, теоретически, для решения рассматриваемой задачи необходимо минимум $7/2=3.5$ соответствий точек.

    Интерес работы \cite{p35p} заключается в том, что для решения используется именно минимальное теоретическое количество соответствий точек -- 3,5, где под использованием половины соответствия, понимается использование ограничений только по одной из двух координат точки изображения. 
    Ограничение по оставшейся координате используется для выделения подходящих решений.
    
    Автор использует специфическую параметризацию, чтобы свести задачу к решению системы из четырёх уравнений шестой степени с двумя неизвестными, которые далее решаются с помощью базисов Грёбнера.
    
    Результатом работы данного алгоритма может являться до 10 решений, однако если использовать оставшуюся координату, не участвующую в нахождении решения, то можно проверить невязку, с помощью уравнения $P\widetilde X = \widetilde x$, и, почти всегда, исключить ненужные решения, оставив только одно. Уменьшение числа количества решений ведёт за собой уменьшение времени, требующегося на использование данного алгоритма в рамках RANSAC.
    
\subsection{P4Pf}

В данной статье \cite{p4p} авторы приводят эффективный алгоритм для решения системы из трёх квадратных уравнений с тремя неизвестными.
А затем указывает способ по приведению задачи P4Pf к аналогичной системе.


\clearpage\section{Сравнение результатов работы}

Сравнение результатов проводилось на сгенерированных данных, по методам указанных в статье \cite{p35p}. Были выбраны точки $X_i$, фокусное расстояние $f$, вращение $R$ и центр камеры $C$, а затем были получен проекции $x_i$.
В результате работы алгоритмов были получены соответствующие оценки $\hat f, \hat R$ и $\hat C$  Работа алгоритмов сравнивалась,  в основном, по относительной ошибке фокусного расстояния: $\Delta_f=\frac{\left\lvert f - \hat{f}\right\rvert}{f}$, а также относительных ошибках центра  и ошибке вращения: $\Delta_C = \frac{\left\lVert C - \hat{C}\right\rVert}{\left\lVert C\right\rVert}$, $\Delta_R = \frac{\left\lVert R - \hat{R}\right\rVert_F}{3}$.

Ниже приводятся сравнение результатов работы алгоритмов.

\textit{Здесь будут графики сравнения Р3.5Р и Р4Р на сгенерированных данных по $\Delta_f, \Delta_R$ и $\Delta_C$ в single и double, графики с шумами и таблица с квантилями, но может быть что-то другое.}

%супер таблица


\clearpage\section{Заключение}
В рамках данной работы было реализованы алгоритмы P3,5Pf \cite{p35p} и P4Pf~\cite{p4p}, а также сравнены результаты их работы в одинарной и двойной точности на синтетически сгенерированных данных.

%вернуться к списку задач
\newpage
\def\thispagestyle#1{} %fixes page number at the top
\bibliographystyle{gost2008}
\bibliography{diploma}

\end{document}
